<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="shortcut icon" type="image/x-icon" href="https://raw.githubusercontent.com/nodecg/nodecg/master/src/favicon.ico">
    <title>util/injectscripts.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Tutorials</li><li class="nav-item"><a href="tutorial-1_what-is-nodecg.html">What is NodeCG?</a></li><li class="nav-item"><a href="tutorial-assets.html">Assets</a></li><li class="nav-item"><a href="tutorial-bundle-configuration.html">Bundle Configuration</a></li><li class="nav-item"><a href="tutorial-custom-routes.html">Custom Routes</a></li><li class="nav-item"><a href="tutorial-making-dialogs.html">Making Dashboard Dialogs</a></li><li class="nav-item"><a href="tutorial-manifest.html">package.json Manifest</a></li><li class="nav-item"><a href="tutorial-migrating-0.7-to-0.8.html">Migrating from 0.7 to 0.8</a></li><li class="nav-item"><a href="tutorial-migrating-0.8-to-0.9.html">Migrating from 0.8 to 0.9</a></li><li class="nav-item"><a href="tutorial-nodecg-configuration.html">NodeCG Configuration</a></li><li class="nav-item"><a href="tutorial-performance-tips.html">Performance Tips</a></li><li class="nav-item"><a href="tutorial-portable-nodecg.html">Portable NodeCG</a></li><li class="nav-item"><a href="tutorial-replicant-schemas.html">Replicant Validation</a></li><li class="nav-item"><a href="tutorial-sentry.html">Error Reporting with Sentry.io</a></li><li class="nav-item"><a href="tutorial-sounds.html">Sounds</a></li><li class="nav-item"><a href="tutorial-using-bower.html">Using Bower Dependencies</a></li><li class="nav-item"><a href="tutorial-using-npm.html">Using npm Dependencies</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="NodeCG.html">NodeCG</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NodeCG.html#findCue">findCue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NodeCG.html#getDialog">getDialog</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NodeCG.html#getDialogDocument">getDialogDocument</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NodeCG.html#getSocketIOServer">getSocketIOServer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NodeCG.html#listenFor">listenFor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NodeCG.html#log">log</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NodeCG.html#mount">mount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NodeCG.html#playSound">playSound</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NodeCG.html#readReplicant">readReplicant</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NodeCG.html#Replicant">Replicant</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NodeCG.html#sendMessage">sendMessage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NodeCG.html#stopAllSounds">stopAllSounds</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NodeCG.html#stopSound">stopSound</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NodeCG.html#unlisten">unlisten</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">util/injectscripts.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const cheerio = require('cheerio');
const fs = require('fs');
const config = require('../config').config;
const filteredConfig = require('../config').filteredConfig;

/**
 * Injects the appropriate assets into a panel, dialog, or graphic.
 * @param {string} pathOrHtml - Either the path to an HTML file, or a string of HTML.
 * @param {('panel'|'dialog'|'graphic')} resourceType
 * @param {Object} [opts] - The options object.
 * @param {boolean} [opts.standalone=false] - Whether or not to inject the scripts required to serve a panel or dialog
 * as a standlone webpage, outside of the dashboard. Only applies when `resourceType` is `panel` or `dialog`.
 * @param {boolean} [opts.createApiInstance=false] - Whether or not to create a `nodecg` API instance object
 * in the global scope of this asset.
 * @param {boolean} [opts.singleInstance=false] - Whether or not to inject the singleInstance scripts.
 * Only applies when `resourceType` is `graphic`.
 * @param {boolean} [opts.sound=false] - Whether or not to inject the sound playback scripts.
 * Only applies when `resourceType` is `graphic`.
 * @param cb
 */
module.exports = function (pathOrHtml, resourceType, opts, cb) {
	// Graphics only pass the path to the html file.
	// Panels and dialogs pass a cached HTML string.
	if (resourceType === 'graphic') {
		fs.readFile(pathOrHtml, inject);
	} else {
		inject(null, pathOrHtml);
	}

	function inject(err, html) {
		if (err) {
			throw err;
		}

		const $ = cheerio.load(html);
		let scripts = [];
		let styles = [];

		// Everything needs the config
		scripts.push(`&lt;script>window.ncgConfig = ${JSON.stringify(filteredConfig)};&lt;/script>`);

		if (resourceType === 'panel' || resourceType === 'dialog') {
			if (opts.standalone) {
				// Load the API
				scripts.push('&lt;script src="/nodecg-api.min.js">&lt;/script>');
			} else {
				// Panels and dialogs can grab the API from the dashboard
				scripts.push('&lt;script>window.NodeCG = window.top.NodeCG&lt;/script>');
			}

			// Both panels and dialogs need the main default styles
			scripts.push('&lt;link rel="stylesheet" href="/dashboard/css/panel-and-dialog-defaults.css">');

			if (opts.standalone) {
				// Load the socket
				scripts.push('&lt;script src="/bower_components/cookies-js/dist/cookies.min.js">&lt;/script>');
				scripts.push('&lt;script src="/socket.io/socket.io.js">&lt;/script>');

				scripts.push(`&lt;script>
					const params = new URLSearchParams(location.search);
					window.token = params.key || Cookies.get('socketToken');
					if (window.token) {
						window.socket = io(undefined, {query: 'token=' + window.token});
					} else {
						window.socket = io();
					}
				&lt;/script>`);
			} else {
				// They both also need to reference the dashboard window's socket, rather than make their own
				scripts.push('&lt;script>window.socket = window.top.socket;&lt;/script>');
			}

			// Likewise, they both need the contentWindow portion of the iframeResizer.
			// We put this at the start and make it async so it loads ASAP.
			if (!opts.fullbleed) {
				scripts.unshift('&lt;script async src="/bower_components/iframe-resizer/js/iframeResizer.contentWindow.min.js">' +
					'&lt;/script>');
			}

			// Panels need the default panel styles and the dialog_opener.
			// Dialogs need the dialog_helper.
			if (resourceType === 'panel') {
				styles.push('&lt;link rel="stylesheet" href="/dashboard/css/panel-defaults.css">');
				scripts.push('&lt;script async src="/dashboard/js/dialog_opener.js">&lt;/script>');
			} else if (resourceType === 'dialog') {
				scripts.push('&lt;script async src="/dashboard/js/dialog_helper.js">&lt;/script>');
			}
		} else if (resourceType === 'graphic') {
			if (config.sentry &amp;&amp; config.sentry.enabled) {
				scripts.unshift(
					'&lt;script src="/bower_components/raven-js/dist/raven.min.js">&lt;/script>',
					`&lt;script>
						Raven.config('${config.sentry.publicDsn}', {
							release: '${require('../../package.json').version}',
							tags: {
								nodecgHost: '${config.host}',
								nodecgBaseURL: '${config.baseURL}'
							}
						}).install();
						window.addEventListener('unhandledrejection', function (err) {
							Raven.captureException(err.reason);
						});
					&lt;/script>`
				);
			}

			// Graphics need to create their own socket
			scripts.push('&lt;script src="/socket.io/socket.io.js">&lt;/script>');

			// If login security is enabled, graphics must provide a valid token when they connect to the socket
			// They also need cookies-js and a helper to manage URL query strings
			if (config.login.enabled) {
				scripts.push('&lt;script src="/bower_components/cookies-js/dist/cookies.min.js">&lt;/script>');
				scripts.push('&lt;script src="/login/QueryString.js">&lt;/script>');
				scripts.push(`&lt;script>
					window.token = qs['key'] || Cookies.get('socketToken');
					window.socket = io(undefined,{query: 'token=' + window.token});
				&lt;/script>`);
			} else {
				scripts.push('&lt;script>window.socket = io();&lt;/script>');
			}

			// If this bundle has sounds, inject SoundJS
			if (opts.sound) {
				scripts.push('&lt;script src="/bower_components/SoundJS/lib/soundjs-0.6.2.min.js">&lt;/script>');
			}

			// Graphics must include the API script themselves before attempting to make an instance of it
			scripts.push('&lt;script src="/nodecg-api.min.js">&lt;/script>');
		} else {
			throw new Error(`Invalid resourceType "${resourceType}"`);
		}

		// Inject a small script to create a NodeCG API instance, if requested.
		if (opts.createApiInstance) {
			const partialBundle = {
				name: opts.createApiInstance.name,
				config: opts.createApiInstance.config,
				_hasSounds: opts.sound
			};

			scripts.push(
				`&lt;script>window.nodecg = new NodeCG(${JSON.stringify(partialBundle)}, window.socket)&lt;/script>`
			);
		}

		// Inject the scripts required for singleInstance behavior, if requested.
		if (opts.singleInstance) {
			scripts.push('&lt;script src="/instance/client_heart.js">&lt;/script>');
		}

		scripts = scripts.join('\n');

		// Put our scripts before their first script or HTML import.
		// If they have no scripts or imports, put our scripts at the end of &lt;body>.
		const theirScriptsAndImports = $('script, link[rel="import"]');
		if (theirScriptsAndImports.length > 0) {
			theirScriptsAndImports.first().before(scripts);
		} else {
			$('body').append(scripts);
		}

		// Inject the needed stylesheets, if any.
		// If there are &lt;script> tags in the head, inject before them.
		// Otherwise, add at the end of the &lt;head>.
		if (styles.length > 0) {
			styles = styles.join('\n');

			const headScripts = $('head').find('script');
			if (headScripts.length > 0) {
				headScripts.first().before(styles);
			} else {
				$('head').append(styles);
			}
		}

		cb($.html());
	}
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.4</a> on Tue Aug 29 2017 10:20:11 GMT-0500 (Central Daylight Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'nodecg/nodecg'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>
</body>
</html>
